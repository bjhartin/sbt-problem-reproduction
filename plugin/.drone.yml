---
kind: pipeline
type: docker
name: default

steps:
  - name: pull_request
    image: mozilla/sbt:latest
    environment:
      GITHUB_API_TOKEN:
        from_secret: BOT_GITHUB_TOKEN
      GITHUB_USERNAME:
        from_secret: BOT_USERNAME
      ARTIFACTORY_USERNAME:
        from_secret: BOT_USERNAME
      ARTIFACTORY_ENCRYPTED_PASSWORD:
        from_secret: BOT_ARTIFACTORY_TOKEN
    commands:
      - sbt clean test
    when:
      event:
        - pull_request

  - name: release
    image: mozilla/sbt:latest
    environment:
      GITHUB_API_TOKEN:
        from_secret: BOT_GITHUB_TOKEN
      GITHUB_USERNAME:
        from_secret: BOT_USERNAME
      ARTIFACTORY_USERNAME:
        from_secret: BOT_USERNAME
      ARTIFACTORY_ENCRYPTED_PASSWORD:
        from_secret: BOT_ARTIFACTORY_TOKEN
    commands:
      - git config remote.origin.fetch +refs/heads/*:refs/remotes/origin/*
      - git config branch.master.remote origin
      - git config branch.master.merge refs/heads/master
      - git config --global user.email "ISGCMSSupport@JohnDeere.com"
      - git config --global user.name "Entity Sync Services Drone"
      - git config --global push.default matching
      - sbt clean 'release with-defaults'
    when:
      event:
        - push

  - name: notify
    image: docker.deere.com/streaming-data/drone-email-notify
    when:
      status: 
        - changed

trigger:
  branch:
    - master
